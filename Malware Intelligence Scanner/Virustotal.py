import requests
import time
import csv

API_KEY = "e729c714cde3c60909c5de326ced52f66cb6f43fb2ddf94971ba5143bd1c4347"
HASH_FILE = "/Users/husseinsbeiti/Desktop/hashes.txt"  

headers = {
    "x-apikey": API_KEY
}

def load_hashes(filepath):
    with open(filepath, "r") as f:
        return [line.strip() for line in f if line.strip()]

def query_hash(hash_value):
    url = f"https://www.virustotal.com/api/v3/files/{hash_value}"
    response = requests.get(url, headers=headers)
    
    if response.status_code == 200:
        data = response.json()
        stats = data['data']['attributes']['last_analysis_stats']
        rep = data['data']['attributes'].get('reputation', 'N/A')
        malicious = stats['malicious']
        total = sum(stats.values())
        is_malicious = "Yes" if malicious > 0 else "No"
        
        return {
            'hash': hash_value,
            'malicious': malicious,
            'total': total,
            'reputation': rep,
            'is_malicious': is_malicious
        }
    else:
        return {
            'hash': hash_value,
            'malicious': 'N/A',
            'total': 'N/A',
            'reputation': 'N/A',
            'is_malicious': 'N/A',
            'error': response.status_code
        }

def main():
    hashes = load_hashes(HASH_FILE)
    print(f"üîç Loaded {len(hashes)} hashes")

    results = []
    for i, h in enumerate(hashes):
        print(f"[{i+1}/{len(hashes)}] Querying: {h}")
        result = query_hash(h)
        results.append(result)
        time.sleep(15)  

    with open("vt_results.csv", "w", newline="") as f:
        writer = csv.DictWriter(f, fieldnames=['hash', 'malicious', 'total', 'reputation', 'is_malicious', 'error'])
        writer.writeheader()
        writer.writerows(results)

    print("Results saved to vt_results.csv")

if __name__ == "__main__":
    main()